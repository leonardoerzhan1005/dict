{% extends "dictionary/base.html" %}
{% load dictionary_extras %}

{% block title %}Редактирование переводов - {{ word.word }}{% endblock %}

{% block extra_head %}
<script src="/static/tinymce/tinymce.min.js"></script>
<script>
// Проверяем загрузку TinyMCE
window.addEventListener('load', function() {
    console.log('Страница загружена');
    if (typeof tinymce !== 'undefined') {
        console.log('TinyMCE загружен успешно');
    } else {
        console.error('TinyMCE не загружен');
    }
});
</script>
<style>
.tox-tinymce {
    
    
}
.tox .tox-toolbar {
    padding-bottom: 100px;
}
.tox .tox-tbtn {
    color: white !important;
}
.tox .tox-tbtn:hover {
    background-color: rgba(255,255,255,0.2) !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Редактирование переводов слова: <strong>{{ word.word }}</strong></h1>
        <div>
            <a href="{% url 'dictionary:word_translations_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад к списку
            </a>
        </div>
    </div>

    <!-- Информация о слове -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Информация о слове</h6>
                </div>
                <div class="card-body">
                    <h3><strong>Слово:</strong> {{ word.word }}</h3>
                    <p><strong>Значение:</strong></p>
                    <div class="border p-3 bg-light tinymce-content">
                        {{ word.meaning|safe }}
                    </div>
                    <p><strong>Язык:</strong> {{ word.language.name }} ({{ word.language.code }})</p>
                    <p><strong>Категория:</strong> 
                        {% if word.category %}
                            {{ word.category.code }}
                        {% else %}
                            <span class="text-muted">Не указана</span>
                        {% endif %}
                    </p>
                    <p><strong>Статус:</strong> 
                        <span class="badge {% if word.status == 'approved' %}bg-success{% elif word.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ word.get_status_display }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar"></i> Статистика переводов</h6>
                </div>
                <div class="card-body">
                    <p><strong>Всего переводов:</strong> {{ word.from_translations.count }}</p>
                    <p><strong>Языки переводов:</strong>
                        {% for translation in word.from_translations.all %}
                            <span class="badge bg-info">{{ translation.to_word.language.code }}</span>
                        {% empty %}
                            <span class="text-muted">Нет переводов</span>
                        {% endfor %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="translation-form">
        {% csrf_token %}
        
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-language"></i> Переводы на другие языки</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for language in languages %}
                    {% if language.id != word.language.id %}
                    <div class="col-md-6 mb-3">
                        <div class="card {% if existing_translations|get_item:language.code|get_item:'word' %}border-success{% else %}border-warning{% endif %}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-flag"></i> {{ language.name }} ({{ language.code }})
                                </h6>
                                <span class="badge {% if existing_translations|get_item:language.code|get_item:'word' %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if existing_translations|get_item:language.code|get_item:'word' %}Переведено{% else %}Не переведено{% endif %}
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="translation_word_{{ language.code }}" class="form-label">
                                        Перевод слова <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control translation-field" 
                                           id="translation_word_{{ language.code }}" 
                                           name="translation_word_{{ language.code }}"
                                           value="{{ existing_translations|get_item:language.code|get_item:'word'|default:'' }}"
                                           placeholder="Введите перевод на {{ language.name }}"
                                           data-language="{{ language.code }}">
                                    <div class="form-text">Обязательное поле</div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="translation_meaning_{{ language.code }}" class="form-label">
                                        Значение
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyOriginalMeaning()" title="Копировать значение с исходного слова">
                                            <i class="fas fa-copy"></i> Копировать
                                        </button>
                                    </label>
                                    <textarea class="form-control translation-field tinymce-editor" 
                                              id="translation_meaning_{{ language.code }}" 
                                              name="translation_meaning_{{ language.code }}"
                                              rows="6"
                                              placeholder="Введите значение на {{ language.name }}"
                                              data-language="{{ language.code }}">{{ existing_translations|get_item:language.code|get_item:'meaning'|default:'' }}</textarea>
                                    <div class="form-text">Поддерживает форматирование текста, изображения и таблицы</div>
                                </div>
                                <div class="form-group">
                                    <label for="note_{{ language.code }}" class="form-label">Примечание</label>
                                    <textarea class="form-control translation-field" 
                                              id="note_{{ language.code }}" 
                                              name="note_{{ language.code }}"
                                              rows="2"
                                              placeholder="Дополнительная информация"
                                              data-language="{{ language.code }}">{{ existing_translations|get_item:language.code|get_item:'note'|default:'' }}</textarea>
                                    <div class="form-text">Необязательное поле</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Сохранить все переводы
            </button>
            <a href="{% url 'dictionary:word_translations_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Отмена
            </a>
        </div>
    </form>
</div>

<script>
// Инициализация TinyMCE для всех редакторов
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен, инициализируем TinyMCE...');
    
    // Проверяем, что TinyMCE загружен
    if (typeof tinymce === 'undefined') {
        console.error('TinyMCE не загружен!');
        return;
    }
    
    console.log('TinyMCE доступен:', typeof tinymce);
    
    const editors = document.querySelectorAll('.tinymce-editor');
    console.log('Найдено редакторов:', editors.length);
    
    editors.forEach(function(editor) {
        console.log('Инициализируем редактор:', editor.id);
        tinymce.init({
            selector: '#' + editor.id,
            height: 300,
            width: '100%',
            plugins: 'save link image table paste lists advlist wordcount charmap nonbreaking anchor pagebreak insertdatetime media directionality emoticons template paste textpattern codesample advlist autolink lists link image charmap preview anchor pagebreak insertdatetime media table code help wordcount',
            toolbar1: 'save | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media table | forecolor backcolor emoticons | fontselect fontsizeselect',
            toolbar2: 'table | charmap | pagebreak | codesample | ltr rtl | spellchecker | advlist | autolink | lists charmap | print preview | anchor | insertdatetime | media | help',
            toolbar3: 'undo redo | cut copy paste | searchreplace | visualblocks visualchars | fullscreen | insertfile image media template link anchor | ltr rtl',
            contextmenu: 'formats | link image table',
            menubar: true,
            statusbar: true,
            language: 'ru',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; }',
            extended_valid_elements: 'img[src|alt|title|width|height|style],a[href|target|title],table[width|height|border|cellpadding|cellspacing|style],tr[style],td[width|height|style|colspan|rowspan],th[width|height|style|colspan|rowspan]',
            images_upload_url: '/tinymce/upload/image/',
            file_picker_types: 'image file',
            images_reuse_filename: true,
            images_upload_base_path: '/media/',
            automatic_uploads: true,
            images_upload_credentials: true,
            paste_data_images: true,
            browser_spellcheck: true,
            verify_html: false,
            entity_encoding: 'raw',
            relative_urls: false,
            remove_script_host: false,
            convert_urls: false,
            setup: function(editor) {
                console.log('TinyMCE инициализирован для:', editor.id);
                
                // Подавляем предупреждения о политике разрешений
                if (window.console && window.console.warn) {
                    var originalWarn = console.warn;
                    console.warn = function() {
                        if (arguments[0] && typeof arguments[0] === 'string' && 
                            arguments[0].includes('Permissions policy violation')) {
                            return;
                        }
                        return originalWarn.apply(console, arguments);
                    };
                }
                
                // Функция для получения CSRF токена
                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                
                // Добавляем обработчик для отладки
                editor.on('change', function() {
                    console.log('Контент изменен в:', editor.id);
                });
                
                // Добавляем обработчик для загрузки изображений
                editor.on('BeforeSetContent', function(e) {
                    console.log('Устанавливаем контент в:', editor.id);
                });
                
                editor.on('SetContent', function(e) {
                    console.log('Контент установлен в:', editor.id);
                });
            }
        });
    });
});

// Валидация формы
document.getElementById('translation-form').addEventListener('submit', function(e) {
    const requiredFields = document.querySelectorAll('input[name^="translation_word_"]');
    let hasErrors = false;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            hasErrors = true;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (hasErrors) {
        e.preventDefault();
        alert('Пожалуйста, заполните все обязательные поля (отмечены звездочкой)');
    }
});

// Обновление статуса при вводе
document.querySelectorAll('.translation-field').forEach(field => {
    field.addEventListener('input', function() {
        updateCardStatus(this);
    });
});

// Функция обновления статуса карточки
function updateCardStatus(field) {
    const card = field.closest('.card');
    const badge = card.querySelector('.badge');
    
    if (field.name.startsWith('translation_word_') && field.value.trim()) {
        card.classList.remove('border-warning');
        card.classList.add('border-success');
        if (badge) {
            badge.textContent = 'Переведено';
            badge.classList.remove('bg-warning');
            badge.classList.add('bg-success');
        }
    } else if (field.name.startsWith('translation_word_') && !field.value.trim()) {
        card.classList.remove('border-success');
        card.classList.add('border-warning');
        if (badge) {
            badge.textContent = 'Не переведено';
            badge.classList.remove('bg-success');
            badge.classList.add('bg-warning');
        }
    }
}

// Добавляем обработчики для TinyMCE редакторов
document.addEventListener('DOMContentLoaded', function() {
    // Ждем инициализации TinyMCE
    setTimeout(function() {
        document.querySelectorAll('.tinymce-editor').forEach(function(textarea) {
            const editor = tinymce.get(textarea.id);
            if (editor) {
                editor.on('change', function() {
                    updateCardStatus(textarea);
                });
            }
        });
    }, 1000);
});

// Копирование значения с исходного слова
function copyOriginalMeaning() {
    const originalMeaning = `{{ word.meaning|escapejs }}`;
    if (originalMeaning) {
        document.querySelectorAll('textarea[name^="translation_meaning_"]').forEach(textarea => {
            if (!textarea.value.trim()) {
                // Если это TinyMCE редактор, используем его API
                const editor = tinymce.get(textarea.id);
                if (editor) {
                    editor.setContent(originalMeaning);
                } else {
                    textarea.value = originalMeaning;
                }
            }
        });
    }
}
</script>

<style>
.card-header h6 {
    margin: 0;
    color: #495057;
}
.form-group label {
    font-weight: 500;
    color: #495057;
}
.border-success {
    border-color: #28a745 !important;
}
.border-warning {
    border-color: #ffc107 !important;
}
.is-invalid {
    border-color: #dc3545 !important;
}
</style>
{% endblock %} 