{% extends "dictionary/base.html" %}
{% load dictionary_extras %}

{% block title %}Редактирование переводов - {{ word.word }}{% endblock %}

{% block extra_head %}
<script src="/static/tinymce/tinymce.min.js"></script>
<script>
// Проверяем загрузку TinyMCE
window.addEventListener('load', function() {
    console.log('Страница загружена');
    if (typeof tinymce !== 'undefined') {
        console.log('TinyMCE загружен успешно');
    } else {
        console.error('TinyMCE не загружен');
    }
});
</script>
<style>
/* Стили для страницы редактирования переводов в темной теме */
.translation-edit-title {
    color: #fff;
    font-family: "Charter", "Georgia", serif;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0;
}

.translation-edit-title strong {
    color: #fff;
    font-weight: 900;
}

/* Кнопка назад */
.btn-translation-back {
    background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    color: #fff;
    border: 2px solid #6c757d;
    border-radius: 0;
    font-family: "Charter", "Georgia", serif;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}

.btn-translation-back:hover {
    background: linear-gradient(135deg, #545b62 0%, #6c757d 100%);
    color: #fff;
    border-color: #545b62;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(108,117,125,0.4);
}

/* Карточки информации */
.info-card {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid #333;
    border-radius: 0;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    color: #fff;
    font-family: "Charter", "Georgia", serif;
}

.info-card .card-header {
    background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
    border-bottom: 2px solid #333;
    color: #fff;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 1.5rem;
}

.info-card .card-header h6 {
    margin: 0;
    font-weight: 900;
    color: #fff;
}

.info-card .card-header i {
    margin-right: 0.5rem;
    color: #fff;
}

.info-card .card-body {
    padding: 2rem;
    background-color: #1a1a1a;
}

.info-card h3 {
    color: #fff;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.info-card p {
    color: #ccc;
    margin-bottom: 0.5rem;
}

.info-card strong {
    color: #fff;
    font-weight: 700;
}

/* Бейджи */
.badge {
    border-radius: 0;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.8rem;
    padding: 0.5rem 0.8rem;
}

.badge.bg-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    color: #fff !important;
}

.badge.bg-warning {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%) !important;
    color: #000 !important;
}

.badge.bg-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
    color: #fff !important;
}

.badge.bg-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    color: #fff !important;
}

/* Карточки переводов */
.translation-card {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 1px solid #333;
    border-radius: 0;
    
    color: #fff;
    font-family: "Charter", "Georgia", serif;
    
}

.translation-card:hover {
    
    
}

.translation-card.border-success {
    border-color: #28a745 !important;
}

.translation-card.border-warning {
    border-color: #404040 !important;
}

.translation-card .card-header {
    background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
    border-bottom: 2px solid #333;
    color: #fff;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 1.5rem;
}

.translation-card .card-header h6 {
    margin: 0;
    font-weight: 900;
    color: #fff;
}

.translation-card .card-header i {
    margin-right: 0.5rem;
    color: #fff;
}

.translation-card .card-body {
    padding: 2rem;
    background-color: #aa976d;
    border: 1px solid #9b8b7f;
}

/* Стили для форм */
.form-label {
    color: #fff;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.translation-field {
    background-color: #d4d4d4 !important;
    border: 1px solid #444 !important;
    border-radius: 0 !important;
    color: #fff !important;
    padding: 0.75rem 1rem !important;
    font-size: 1rem !important;
    font-family: "Charter", "Georgia", serif !important;
    transition: all 0.3s ease !important;
}

.translation-field::placeholder {
    color: #888 !important;
}

.translation-field:focus {
    background-color: #333 !important;
    border-color: #fff !important;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.1) !important;
    outline: none !important;
    color: #fff !important;
}

.form-text {
    color: #ccc;
    font-size: 0.85rem;
    font-style: italic;
}

/* Кнопки */
.btn-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: #fff;
    border: 2px solid #007bff;
    border-radius: 0;
    font-family: "Charter", "Georgia", serif;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 1rem 2rem;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #0056b3 0%, #007bff 100%);
    color: #fff;
    border-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,123,255,0.4);
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    color: #fff;
    border: 2px solid #6c757d;
    border-radius: 0;
    font-family: "Charter", "Georgia", serif;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: 1rem 2rem;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #545b62 0%, #6c757d 100%);
    color: #fff;
    border-color: #545b62;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(108,117,125,0.4);
}

.btn-outline-secondary {
    
    color: #101010;
    border: 1px solid #2f2f2f;
    border-radius: 0;
    font-family: "Charter", "Georgia", serif;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
    background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
    color: #fff;
    border-color: #6c757d;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(108,117,125,0.4);
}

.btn i {
    margin-right: 0.5rem;
}

/* TinyMCE контент */
.tinymce-content {
    background-color: #2d2d2d !important;
    border: 1px solid #444 !important;
    border-radius: 0 !important;
    color: #fff !important;
    padding: 1rem !important;
    font-family: "Charter", "Georgia", serif !important;
    line-height: 1.6;
}

.tinymce-content p {
    margin-bottom: 0.5rem;
    color: #fff;
}

.tinymce-content strong {
    color: #fff;
    font-weight: 700;
}

.tinymce-content em {
    color: #ffc107;
    font-style: italic;
}



/* Ошибки валидации */
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 3px rgba(220,53,69,0.1) !important;
}

/* Анимация появления */
.info-card, .translation-card {
    animation: fadeInUp 0.6s ease-out;
}

.info-card:nth-child(1) { animation-delay: 0.1s; }
.info-card:nth-child(2) { animation-delay: 0.2s; }
.translation-card:nth-child(odd) { animation-delay: 0.3s; }
.translation-card:nth-child(even) { animation-delay: 0.4s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Адаптивность */
@media (max-width: 768px) {
    .info-card .card-body, .translation-card .card-body {
        padding: 1.5rem;
    }
    
    .info-card .card-header, .translation-card .card-header {
        padding: 1rem;
    }
    
    .translation-edit-title {
        font-size: 1.5rem;
    }
    
    .btn {
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
    }
}

/* Дополнительные эффекты */
.btn:active {
    transform: translateY(0);
}

.text-muted {
    color: #888 !important;
}

.text-danger {
    color: #ff6b6b !important;
}

/* Стили для табов языков */
.nav-tabs {
    border-bottom: 2px solid #333;
    margin-bottom: 0;
}

.nav-tabs .nav-item {
    margin-bottom: -2px;
}

.nav-tabs .nav-link {
    background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    border: 2px solid transparent;
    border-bottom: 2px solid #333;
    border-radius: 0;
    color: #ccc;
    font-family: "Charter", "Georgia", serif;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 1rem 1.5rem;
    margin-right: 0.5rem;
    transition: all 0.3s ease;
    position: relative;
}

.nav-tabs .nav-link:hover {
    background: linear-gradient(135deg, #3d3d3d 0%, #2a2a2a 100%);
    color: #fff;
    border-color: #555;
    transform: translateY(-2px);
}

.nav-tabs .nav-link.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: #fff;
    border-color: #007bff;
    border-bottom-color: #007bff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

.nav-tabs .nav-link .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0;
}

.tab-content {
    background: #1a1a1a;
    border: 1px solid #333;
    border-top: none;
    padding: 2rem;
    min-height: 400px;
}

.tab-pane {
    display: none;
}

.tab-pane.show {
    display: block;
}

.tab-pane.active {
    display: block;
}

/* Анимация переключения табов */
.tab-pane.fade {
    opacity: 0;
    transition: opacity 0.15s linear;
}

.tab-pane.fade.show {
    opacity: 1;
}

/* Стили для содержимого табов */
.tab-content .card {
    background: transparent;
    border: none;
    box-shadow: none;
}

.tab-content .card-header {
    background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
    border-bottom: 2px solid #333;
    padding: 1.5rem;
}

.tab-content .card-body {
    background: #2d2d2d;
    padding: 2rem;
    border: 1px solid #444;
    border-top: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="translation-edit-title">Редактирование переводов слова: <strong>{{ word.word }}</strong></h1>
        <div>
            <a href="{% url 'dictionary:word_translations_dashboard' %}" class="btn btn-translation-back">
                <i class="fas fa-arrow-left"></i> Назад к списку
            </a>
        </div>
    </div>

    <!-- Информация о слове -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card info-card">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Информация о слове</h6>
                </div>
                <div class="card-body">
                    <h3><strong>Слово:</strong> {{ word.word }}</h3>
                    <p><strong>Значение:</strong></p>
                    <div class="border p-3 bg-light tinymce-content">
                        {{ word.meaning|safe }}
                    </div>
                    <p><strong>Язык:</strong> {{ word.language.name }} ({{ word.language.code }})</p>
                    <p><strong>Категория:</strong> 
                        {% if word.category %}
                            {{ word.category.code }}
                        {% else %}
                            <span class="text-muted">Не указана</span>
                        {% endif %}
                    </p>
                    <p><strong>Статус:</strong> 
                        <span class="badge {% if word.status == 'approved' %}bg-success{% elif word.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ word.get_status_display }}
                        </span>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card info-card">
                <div class="card-header">
                    <h6><i class="fas fa-chart-bar"></i> Статистика переводов</h6>
                </div>
                <div class="card-body">
                    <p><strong>Всего переводов:</strong> {{ word.from_translations.count }}</p>
                    <p><strong>Языки переводов:</strong>
                        {% for translation in word.from_translations.all %}
                            <span class="badge bg-info">{{ translation.to_word.language.code }}</span>
                        {% empty %}
                            <span class="text-muted">Нет переводов</span>
                        {% endfor %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="translation-form">
        {% csrf_token %}
        
        <!-- Отладочная информация -->
        <div class="alert alert-info" id="debug-info" style="display: none;">
            <strong>Отладочная информация:</strong>
            <div id="debug-content"></div>
        </div>
        
        <!-- Переключатель языков -->
        <div class="card translation-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-language"></i> Переводы на другие языки</h5>
                <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleDebug()">
                    <i class="fas fa-bug"></i> Отладка
                </button>
            </div>
            <div class="card-body">
                <!-- Навигация по языкам -->
                <ul class="nav nav-tabs" id="languageTabs" role="tablist">
                    {% for language in languages %}
                    {% if language.id != word.language.id %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                id="tab-{{ language.code }}" 
                                data-bs-toggle="tab" 
                                data-bs-target="#content-{{ language.code }}" 
                                type="button" 
                                role="tab" 
                                aria-controls="content-{{ language.code }}" 
                                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                            <i class="fas fa-flag"></i> {{ language.name }} ({{ language.code }})
                            <span class="badge {% if existing_translations|get_item:language.code|get_item:'word' %}bg-success{% else %}bg-warning{% endif %} ms-2">
                                {% if existing_translations|get_item:language.code|get_item:'word' %}✓{% else %}!{% endif %}
                            </span>
                        </button>
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>

                <!-- Содержимое табов -->
                <div class="tab-content mt-3" id="languageTabContent">
                    {% for language in languages %}
                    {% if language.id != word.language.id %}
                    <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                         id="content-{{ language.code }}" 
                         role="tabpanel" 
                         aria-labelledby="tab-{{ language.code }}">
                        
                        <div class="card {% if existing_translations|get_item:language.code|get_item:'word' %}border-success{% else %}border-warning{% endif %}">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-flag"></i> Перевод на {{ language.name }} ({{ language.code }})
                                    {% if existing_translations|get_item:language.code|get_item:'word' %}
                                        <span class="badge bg-success ms-2">Переведено</span>
                                    {% else %}
                                        <span class="badge bg-warning ms-2">Требует перевода</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="translation_word_{{ language.code }}" class="form-label">
                                        Перевод слова <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" 
                                           class="form-control translation-field" 
                                           id="translation_word_{{ language.code }}" 
                                           name="translation_word_{{ language.code }}"
                                           value="{{ existing_translations|get_item:language.code|get_item:'word'|default:'' }}"
                                           placeholder="Введите перевод на {{ language.name }}"
                                           data-language="{{ language.code }}">
                                    <div class="form-text">Обязательное поле</div>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="translation_meaning_{{ language.code }}" class="form-label">
                                        Значение
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyOriginalMeaning()" title="Копировать значение с исходного слова">
                                            <i class="fas fa-copy"></i> Копировать
                                        </button>
                                    </label>
                                    <textarea class="form-control translation-field tinymce-editor" 
                                              id="translation_meaning_{{ language.code }}" 
                                              name="translation_meaning_{{ language.code }}"
                                              rows="6"
                                              placeholder="Введите значение на {{ language.name }}"
                                              data-language="{{ language.code }}">{{ existing_translations|get_item:language.code|get_item:'meaning'|default:'' }}</textarea>
                                    <div class="form-text">Поддерживает форматирование текста, изображения и таблицы</div>
                                </div>
                                <div class="form-group">
                                    <label for="note_{{ language.code }}" class="form-label">Примечание</label>
                                    <textarea class="form-control translation-field" 
                                              id="note_{{ language.code }}" 
                                              name="note_{{ language.code }}"
                                              rows="2"
                                              placeholder="Дополнительная информация"
                                              data-language="{{ language.code }}">{{ existing_translations|get_item:language.code|get_item:'note'|default:'' }}</textarea>
                                    <div class="form-text">Необязательное поле</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Навигация между табами -->
        <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
            <div class="btn-group" role="group" aria-label="Навигация по языкам">
                <button type="button" class="btn btn-outline-secondary" id="prevTabBtn" onclick="switchToPreviousTab()">
                    <i class="fas fa-chevron-left"></i> Предыдущий язык
                </button>
                <button type="button" class="btn btn-outline-secondary" id="nextTabBtn" onclick="switchToNextTab()">
                    Следующий язык <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="text-muted">
                <span id="currentTabInfo">Язык: <span id="currentLanguageName">-</span></span>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Сохранить все переводы
            </button>
            <a href="{% url 'dictionary:word_translations_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Отмена
            </a>
        </div>
    </form>
</div>

<script>
// Управление табами языков
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация табов Bootstrap
    const triggerTabList = [].slice.call(document.querySelectorAll('#languageTabs button[data-bs-toggle="tab"]'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
            
            // Обновляем статус активного таба
            document.querySelectorAll('#languageTabs .nav-link').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            triggerEl.classList.add('active');
            triggerEl.setAttribute('aria-selected', 'true');
            
            // Показываем соответствующий контент
            const targetId = triggerEl.getAttribute('data-bs-target');
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            document.querySelector(targetId).classList.add('show', 'active');
            
            console.log('Переключен на язык:', targetId);
            
            // Обновляем информацию о текущем табе
            updateCurrentTabInfo();
        });
    });
    
    // Автоматическое переключение на первый таб при загрузке
    const firstTab = document.querySelector('#languageTabs .nav-link');
    if (firstTab) {
        firstTab.click();
    }
    
    // Обновляем информацию о текущем табе
    updateCurrentTabInfo();
});

// Функции навигации между табами
function switchToNextTab() {
    const currentTab = document.querySelector('#languageTabs .nav-link.active');
    const nextTab = currentTab.parentElement.nextElementSibling;
    
    if (nextTab && nextTab.querySelector('.nav-link')) {
        nextTab.querySelector('.nav-link').click();
    } else {
        // Если это последний таб, переходим к первому
        document.querySelector('#languageTabs .nav-link').click();
    }
}

function switchToPreviousTab() {
    const currentTab = document.querySelector('#languageTabs .nav-link.active');
    const prevTab = currentTab.parentElement.previousElementSibling;
    
    if (prevTab && prevTab.querySelector('.nav-link')) {
        prevTab.querySelector('.nav-link').click();
    } else {
        // Если это первый таб, переходим к последнему
        const tabs = document.querySelectorAll('#languageTabs .nav-link');
        tabs[tabs.length - 1].click();
    }
}

function updateCurrentTabInfo() {
    const currentTab = document.querySelector('#languageTabs .nav-link.active');
    if (currentTab) {
        const languageName = currentTab.textContent.trim().split('(')[0].trim();
        document.getElementById('currentLanguageName').textContent = languageName;
        
        // Обновляем состояние кнопок навигации
        const tabs = document.querySelectorAll('#languageTabs .nav-link');
        const currentIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
        
        document.getElementById('prevTabBtn').disabled = tabs.length <= 1;
        document.getElementById('nextTabBtn').disabled = tabs.length <= 1;
    }
}

// Инициализация TinyMCE для всех редакторов
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен, инициализируем TinyMCE...');
    
    // Проверяем, что TinyMCE загружен
    if (typeof tinymce === 'undefined') {
        console.error('TinyMCE не загружен!');
        return;
    }
    
    console.log('TinyMCE доступен:', typeof tinymce);
    
    const editors = document.querySelectorAll('.tinymce-editor');
    console.log('Найдено редакторов:', editors.length);
    
    editors.forEach(function(editor) {
        console.log('Инициализируем редактор:', editor.id);
        tinymce.init({
            selector: '#' + editor.id,
            height: 300,
            width: '100%',
            plugins: 'save link image table paste lists advlist wordcount charmap nonbreaking anchor pagebreak insertdatetime media directionality emoticons template paste textpattern codesample advlist autolink lists link image charmap preview anchor pagebreak insertdatetime media table code help wordcount',
            toolbar1: 'save | formatselect | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image media table | forecolor backcolor emoticons | fontselect fontsizeselect',
            toolbar2: 'table | charmap | pagebreak | codesample | ltr rtl | spellchecker | advlist | autolink | lists charmap | print preview | anchor | insertdatetime | media | help',
            toolbar3: 'undo redo | cut copy paste | searchreplace | visualblocks visualchars | fullscreen | insertfile image media template link anchor | ltr rtl',
            contextmenu: 'formats | link image table',
            menubar: true,
            statusbar: true,
            language: 'ru',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; }',
            extended_valid_elements: 'img[src|alt|title|width|height|style],a[href|target|title],table[width|height|border|cellpadding|cellspacing|style],tr[style],td[width|height|style|colspan|rowspan],th[width|height|style|colspan|rowspan]',
            images_upload_url: '/tinymce/upload/image/',
            file_picker_types: 'image file',
            images_reuse_filename: true,
            images_upload_base_path: '/media/',
            automatic_uploads: true,
            images_upload_credentials: true,
            paste_data_images: true,
            browser_spellcheck: true,
            verify_html: false,
            entity_encoding: 'raw',
            relative_urls: false,
            remove_script_host: false,
            convert_urls: false,
            setup: function(editor) {
                console.log('TinyMCE инициализирован для:', editor.id);
                
                // Подавляем предупреждения о политике разрешений
                if (window.console && window.console.warn) {
                    var originalWarn = console.warn;
                    console.warn = function() {
                        if (arguments[0] && typeof arguments[0] === 'string' && 
                            arguments[0].includes('Permissions policy violation')) {
                            return;
                        }
                        return originalWarn.apply(console, arguments);
                    };
                }
                
                // Функция для получения CSRF токена
                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                
                // Добавляем обработчик для отладки
                editor.on('change', function() {
                    console.log('Контент изменен в:', editor.id);
                });
                
                // Добавляем обработчик для загрузки изображений
                editor.on('BeforeSetContent', function(e) {
                    console.log('Устанавливаем контент в:', editor.id);
                });
                
                editor.on('SetContent', function(e) {
                    console.log('Контент установлен в:', editor.id);
                });
            }
        });
    });
});

// Валидация формы
document.getElementById('translation-form').addEventListener('submit', function(e) {
    console.log('=== ФОРМА ОТПРАВЛЯЕТСЯ ===');
    console.log('Событие submit сработало');
    
    const requiredFields = document.querySelectorAll('input[name^="translation_word_"]');
    let hasErrors = false;
    let errorMessages = [];
    
    console.log('Найдено обязательных полей:', requiredFields.length);
    
    requiredFields.forEach(field => {
        console.log('Проверяем поле:', field.name, 'значение:', field.value);
        
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            hasErrors = true;
            const languageCode = field.name.split('_')[2];
            errorMessages.push(`Перевод на язык ${languageCode} обязателен`);
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (hasErrors) {
        e.preventDefault();
        console.error('Ошибки валидации:', errorMessages);
        alert('Пожалуйста, заполните все обязательные поля:\n' + errorMessages.join('\n'));
        return false;
    }
    
    console.log('Валидация прошла успешно, отправляем форму');
    console.log('Данные формы перед отправкой:');
    
    // Показываем все данные формы
    const formData = new FormData(this);
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    console.log('CSRF токен:', document.querySelector('[name=csrfmiddlewaretoken]').value);
    console.log('Форма будет отправлена на:', this.action);
    
    return true;
});

// Обновление статуса при вводе
document.querySelectorAll('.translation-field').forEach(field => {
    field.addEventListener('input', function() {
        updateCardStatus(this);
    });
});

// Функция обновления статуса карточки
function updateCardStatus(field) {
    const card = field.closest('.card');
    const badge = card.querySelector('.badge');
    
    if (field.name.startsWith('translation_word_') && field.value.trim()) {
        card.classList.remove('border-warning');
        card.classList.add('border-success');
        if (badge) {
            badge.textContent = 'Переведено';
            badge.classList.remove('bg-warning');
            badge.classList.add('bg-success');
        }
    } else if (field.name.startsWith('translation_word_') && !field.value.trim()) {
        card.classList.remove('border-success');
        card.classList.add('border-warning');
        if (badge) {
            badge.textContent = 'Не переведено';
            badge.classList.remove('bg-success');
            badge.classList.add('bg-warning');
        }
    }
}

// Добавляем обработчики для TinyMCE редакторов
document.addEventListener('DOMContentLoaded', function() {
    // Ждем инициализации TinyMCE
    setTimeout(function() {
        document.querySelectorAll('.tinymce-editor').forEach(function(textarea) {
            const editor = tinymce.get(textarea.id);
            if (editor) {
                editor.on('change', function() {
                    updateCardStatus(textarea);
                });
            }
        });
    }, 1000);
});

// Копирование значения с исходного слова
function copyOriginalMeaning() {
    const originalMeaning = `{{ word.meaning|escapejs }}`;
    if (originalMeaning) {
        document.querySelectorAll('textarea[name^="translation_meaning_"]').forEach(textarea => {
            if (!textarea.value.trim()) {
                // Если это TinyMCE редактор, используем его API
                const editor = tinymce.get(textarea.id);
                if (editor) {
                    editor.setContent(originalMeaning);
                } else {
                    textarea.value = originalMeaning;
                }
            }
        });
    }
}

// Функции отладки
function toggleDebug() {
    const debugInfo = document.getElementById('debug-info');
    const debugContent = document.getElementById('debug-content');
    
    if (debugInfo.style.display === 'none') {
        debugInfo.style.display = 'block';
        showDebugInfo();
    } else {
        debugInfo.style.display = 'none';
    }
}

function showDebugInfo() {
    const debugContent = document.getElementById('debug-content');
    const form = document.getElementById('translation-form');
    const formData = new FormData(form);
    
    let debugText = '<strong>Данные формы:</strong><br>';
    for (let [key, value] of formData.entries()) {
        debugText += `${key}: ${value}<br>`;
    }
    
    debugText += '<br><strong>CSRF токен:</strong> ' + document.querySelector('[name=csrfmiddlewaretoken]').value;
    debugText += '<br><strong>Метод:</strong> ' + form.method;
    debugText += '<br><strong>Action:</strong> ' + form.action;
    
    debugContent.innerHTML = debugText;
}

// Добавляем обработчик для логирования всех изменений в форме
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== СТРАНИЦА ЗАГРУЖЕНА ===');
    console.log('DOM полностью загружен');
    
    const form = document.getElementById('translation-form');
    console.log('Форма найдена:', form ? 'ДА' : 'НЕТ');
    if (form) {
        console.log('Action формы:', form.action);
        console.log('Метод формы:', form.method);
        console.log('CSRF токен присутствует:', !!document.querySelector('[name=csrfmiddlewaretoken]'));
    }
    
    // Проверяем все поля переводов
    const translationFields = document.querySelectorAll('input[name^="translation_word_"]');
    console.log('Найдено полей переводов:', translationFields.length);
    translationFields.forEach((field, index) => {
        console.log(`Поле ${index + 1}:`, field.name, 'значение:', field.value, 'язык:', field.dataset.language);
    });
    
    // Проверяем существующие переводы
    console.log('Существующие переводы из Django:');
    // Данные о существующих переводах будут показаны через кнопку "Отладка"
    
    // Логируем все изменения в полях
    form.addEventListener('change', function(e) {
        console.log('Поле изменено:', e.target.name, 'значение:', e.target.value);
    });
    
    // Логируем отправку формы
    form.addEventListener('submit', function(e) {
        console.log('Форма отправляется...');
        const formData = new FormData(form);
        console.log('Данные формы:');
        for (let [key, value] of formData.entries()) {
            console.log(key + ':', value);
        }
    });
});
</script>

{% endblock %} 